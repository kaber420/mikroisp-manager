{% extends "base.html" %}

{% block title %}Client Details - µMonitor Pro{% endblock %}

{% block styles %}
<link rel="stylesheet" href="/static/css/dashboard-transitions.css">
{# Custom styles moved to input.css for CSP compliance #}
{% endblock %}

{% block content %}
<main class="flex-1 p-6 lg:p-8" x-data="clientDetails">
    <!-- Título -->
    <div class="flex items-center gap-4 mb-8">
        <a href="/clients" title="Back to Clients" class="text-primary hover:opacity-75">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
        </a>
        <h1 id="main-clientname" class="text-4xl font-bold">Loading Client...</h1>
    </div>

    <!-- Pestañas -->
    <div class="border-b border-border-color flex mb-6">
        <button type="button" data-tab="info" class="tab-button active py-3 px-6 text-sm font-semibold">Info & Service
            Status</button>
        <button type="button" data-tab="billing"
            class="tab-button py-3 px-6 text-sm font-semibold text-text-secondary">Billing & Payments</button>
    </div>

    <!-- Panel 1: Información y Estado -->
    <div id="tab-info" class="tab-panel active">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Columna de Información del Cliente -->
            <div class="bg-surface-1 rounded-lg border border-border-color">
                <div class="p-6 border-b border-border-color">
                    <h2 class="text-xl font-bold">Client Information</h2>
                </div>
                <div id="client-info-container" class="p-6 text-sm space-y-2">
                    <p class="text-text-secondary text-center">Loading info...</p>
                </div>
            </div>
            <!-- Columna de Estado del Servicio -->
            <div class="bg-surface-1 rounded-lg border border-border-color">
                <div class="p-6 border-b border-border-color">
                    <h2 class="text-xl font-bold">Live Service Status</h2>
                </div>
                <div id="service-status-container" class="p-6 text-sm space-y-2">
                    <p class="text-text-secondary text-center">Loading status...</p>
                </div>
            </div>
        </div>

        <!-- Services List Section -->
        <div class="bg-surface-1 rounded-lg border border-border-color mt-6">
            <div class="p-6 border-b border-border-color flex justify-between items-center">
                <h2 class="text-xl font-bold">Network Services</h2>
            </div>
            <div class="p-6">
                <!-- Empty State -->
                <template x-if="allServices.length === 0">
                    <p class="text-text-secondary text-center">No network services configured for this client.</p>
                </template>

                <!-- List -->
                <div class="space-y-3">
                    <template x-for="service in allServices" :key="service.id">
                        <div class="flex flex-col p-4 bg-surface-2 rounded-lg gap-3">
                            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full"
                                            :class="service.service_type === 'pppoe' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'"
                                            x-text="service.service_type === 'pppoe' ? 'PPPoE' : 'Simple Queue'"></span>
                                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full" :class="{
                                                'active': 'bg-success/20 text-success',
                                                'pendiente': 'bg-warning/20 text-warning',
                                                'suspended': 'bg-danger/20 text-danger',
                                                'cancelled': 'bg-surface-2 text-text-secondary'
                                            }[service.status || 'active'] || 'bg-surface-2 text-text-secondary'"
                                            x-text="service.status ? (service.status.charAt(0).toUpperCase() + service.status.slice(1)) : 'Active'"></span>
                                        <span class="font-mono text-sm font-semibold"
                                            x-text="service.pppoe_username || service.ip_address || 'N/A'"></span>
                                    </div>
                                    <div class="text-xs text-text-secondary space-x-4">
                                        <span>Router: <span class="font-mono"
                                                x-text="service.router_host || 'N/A'"></span></span>
                                        <span>Plan: <span class="font-semibold text-primary"
                                                x-text="service.plan_name || service.profile_name || 'No Plan'"></span></span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="openEditServiceModal(service.id)"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-secondary/20 text-secondary hover:bg-secondary/30 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">edit</span>
                                        Edit
                                    </button>
                                    <button
                                        @click="openPlanChangeModal(service.id, service.pppoe_username || service.ip_address || 'N/A')"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-primary/20 text-primary hover:bg-primary/30 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">swap_horiz</span>
                                        Change Plan
                                    </button>
                                    <button
                                        @click="deleteService(service.id, service.pppoe_username || service.ip_address || 'N/A')"
                                        class="px-3 py-1.5 text-xs font-semibold rounded-md bg-danger/20 text-danger hover:bg-danger/30 flex items-center gap-1">
                                        <span class="material-symbols-outlined text-sm">delete</span>
                                        Delete
                                    </button>
                                </div>
                            </div>
                            <div
                                class="grid grid-cols-1 sm:grid-cols-3 gap-2 text-xs text-text-secondary border-t border-border-color pt-3">
                                <div><span class="font-medium">Address:</span> <span
                                        x-text="service.address || 'N/A'"></span></div>
                                <div><span class="font-medium">Billing Day:</span> <span
                                        x-text="service.billing_day || 'N/A'"></span></div>
                                <div><span class="font-medium">Notes:</span> <span
                                        x-text="service.notes || 'N/A'"></span></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Change Modal -->
    <div id="plan-change-modal"
        class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-surface-1 rounded-lg shadow-xl w-full max-w-md border border-border-color">
            <div class="p-6 border-b border-border-color flex justify-between items-center">
                <h3 class="text-xl font-bold">Change Service Plan</h3>
                <button type="button" onclick="closePlanChangeModal()"
                    class="text-text-secondary hover:text-text-primary text-2xl font-bold">&times;</button>
            </div>
            <form id="plan-change-form" class="p-6 space-y-4">
                <input type="hidden" id="plan-change-service-id">
                <div>
                    <p class="text-sm text-text-secondary mb-2">Current Service: <span id="plan-change-service-name"
                            class="font-semibold text-text-primary"></span></p>
                </div>
                <div>
                    <label for="new-plan-select" class="block text-sm font-medium mb-1">New Plan</label>
                    <select id="new-plan-select" class="w-full bg-background border border-border-color rounded-md p-2">
                        <option value="">Select a plan...</option>
                    </select>
                </div>
                <div id="plan-change-error" class="text-danger text-sm hidden"></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closePlanChangeModal()"
                        class="px-4 py-2 rounded-md text-sm font-semibold hover:bg-surface-2">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-md text-sm font-semibold text-white bg-primary hover:bg-primary-hover">Change
                        Plan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Service Modal -->
    <div id="edit-service-modal"
        class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-surface-1 rounded-lg shadow-xl w-full max-w-md border border-border-color">
            <div class="p-6 border-b border-border-color flex justify-between items-center">
                <h3 class="text-xl font-bold">Edit Service Details</h3>
                <button type="button" onclick="closeEditServiceModal()"
                    class="text-text-secondary hover:text-text-primary text-2xl font-bold">&times;</button>
            </div>
            <form id="edit-service-form" class="p-6 space-y-4">
                <input type="hidden" id="edit-service-id">

                <!-- Read-only Info -->
                <div>
                    <label class="block text-sm font-medium mb-1">Service Identifier</label>
                    <input type="text" id="edit-service-identifier" readonly disabled
                        class="w-full bg-surface-2 border border-border-color rounded-md p-2 text-text-secondary cursor-not-allowed">
                </div>

                <!-- Editable Fields -->
                <div>
                    <label for="edit-service-billing-day" class="block text-sm font-medium mb-1">Billing Day</label>
                    <select id="edit-service-billing-day"
                        class="w-full bg-background border border-border-color rounded-md p-2">
                        <option value="">Select Day...</option>
                        <!-- Generated by JS 1-28 -->
                    </select>
                </div>

                <div>
                    <label for="edit-service-notes" class="block text-sm font-medium mb-1">Notes</label>
                    <textarea id="edit-service-notes" rows="3"
                        class="w-full bg-background border border-border-color rounded-md p-2"></textarea>
                </div>

                <div id="edit-service-error" class="text-danger text-sm hidden"></div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" onclick="closeEditServiceModal()"
                        class="px-4 py-2 rounded-md text-sm font-semibold hover:bg-surface-2">Cancel</button>
                    <button type="submit"
                        class="px-4 py-2 rounded-md text-sm font-semibold text-white bg-primary hover:bg-primary-hover">Save
                        Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Panel 2: Facturación y Pagos -->
    <div id="tab-billing" class="tab-panel" x-data="billingPanel">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Columna para Registrar Pago -->
            <div class="bg-surface-1 rounded-lg border border-border-color">
                <div class="p-6 border-b border-border-color">
                    <h2 class="text-xl font-bold">Register New Payment</h2>
                </div>
                <form id="register-payment-form" class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="payment-amount" class="block text-sm font-medium mb-1">Amount</label>
                            <input type="number" step="0.01" id="payment-amount" required
                                class="w-full bg-background border border-border-color rounded-md p-2">
                        </div>

                        <div class="col-span-full">
                            <label class="block text-sm font-medium mb-2">Seleccionar Mes a Pagar</label>

                            <div class="flex items-center gap-4 mb-3">
                                <button type="button" id="prev-year-btn" class="p-1 rounded hover:bg-surface-2"><span
                                        class="material-symbols-outlined">chevron_left</span></button>
                                <span id="current-year-display" class="font-bold text-lg">2025</span>
                                <button type="button" id="next-year-btn" class="p-1 rounded hover:bg-surface-2"><span
                                        class="material-symbols-outlined">chevron_right</span></button>
                            </div>

                            <div id="months-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-2">
                            </div>

                            <input type="hidden" id="payment-month" required>

                            <div id="cycle-info"
                                class="mt-3 p-3 bg-primary/10 border border-primary/20 rounded-md hidden">
                                <p class="text-sm text-primary font-semibold flex items-center gap-2">
                                    <span class="material-symbols-outlined text-sm">date_range</span>
                                    Ciclo: <span id="cycle-dates">--</span>
                                </p>
                                <p class="text-xs text-text-secondary mt-1">Este pago cubre el servicio entre estas
                                    fechas.</p>
                            </div>
                        </div>

                        <div>
                            <label for="payment-method" class="block text-sm font-medium mb-1">Method</label>
                            <select id="payment-method"
                                class="w-full bg-background border border-border-color rounded-md p-2">
                                <option value="Efectivo">Cash</option>
                                <option value="Transferencia">Transfer</option>
                                <option value="Otro">Other</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="payment-notes" class="block text-sm font-medium mb-1">Notes (Optional)</label>
                        <input type="text" id="payment-notes" placeholder="Reference no., etc."
                            class="w-full bg-background border border-border-color rounded-md p-2">
                    </div>
                    <div id="payment-form-error" class="form-error-main text-danger text-sm hidden"></div>
                    <div class="text-right pt-2">
                        <button type="submit"
                            class="px-4 py-2 rounded-md text-sm font-semibold text-white bg-primary hover:bg-primary-hover">
                            Register Payment & Reactivate
                        </button>
                    </div>
                </form>
            </div>
            <!-- Columna para Historial de Pagos -->
            <div class="bg-surface-1 rounded-lg border border-border-color">
                <div class="p-6 border-b border-border-color">
                    <h2 class="text-xl font-bold">Payment History</h2>
                </div>
                <div class="p-6 space-y-2 max-h-96 overflow-y-auto">
                    <!-- Loading State -->
                    <template x-if="loading">
                        <p class="text-text-secondary">Loading history...</p>
                    </template>

                    <!-- Empty State -->
                    <template x-if="!loading && payments.length === 0">
                        <p class="text-text-secondary">No payments registered for this client.</p>
                    </template>

                    <!-- List -->
                    <template x-for="payment in payments" :key="payment.id">
                        <div class="flex justify-between items-center bg-surface-2 p-3 rounded-md">
                            <div class="flex-grow">
                                <p class="font-semibold text-text-primary">
                                    $<span x-text="payment.monto.toFixed(2)"></span> -
                                    <span class="font-medium text-text-secondary"
                                        x-text="'For: ' + payment.mes_correspondiente"></span>
                                </p>
                                <p class="text-xs text-text-secondary">
                                    <span
                                        x-text="new Date(payment.fecha_pago).toLocaleString(undefined, { dateStyle: 'medium', timeStyle: 'short' })"></span>
                                    (<span x-text="payment.metodo_pago || 'N/A'"></span>)
                                </p>
                                <template x-if="payment.notas">
                                    <p class="text-xs text-warning mt-1" x-text="payment.notas"></p>
                                </template>
                            </div>
                            <div>
                                <button @click="openPrintModal(payment.id)" class="p-2 rounded-md hover:bg-surface-3"
                                    title="Print Receipt">
                                    <span class="material-symbols-outlined">print</span>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block scripts %}
<script nonce="{{ request.state.csp_nonce }}" src="/static/js/utils/validators.js"></script>
<!-- Alpine.js Store and Components (defer ensures load after Alpine) -->
<script nonce="{{ request.state.csp_nonce }}" src="/static/js/stores/ClientStore.js" defer></script>
<script nonce="{{ request.state.csp_nonce }}" src="/static/js/components/ClientDetails.js" defer></script>
<script nonce="{{ request.state.csp_nonce }}" src="/static/js/components/BillingPanel.js" defer></script>
{% endblock %}